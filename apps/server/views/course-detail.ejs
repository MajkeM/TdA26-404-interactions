<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= course.name %> - Think different Academy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; }
    .navbar { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar a { color: #333; text-decoration: none; margin-left: 1.5rem; font-weight: 500; }
    .navbar a:hover { color: #667eea; }
    .logo { font-weight: bold; font-size: 1.5rem; color: #667eea; }
    .container { max-width: 800px; margin: 0 auto; padding: 2rem; }
    .back-link { display: inline-block; margin-bottom: 1.5rem; color: #667eea; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    .course-detail { background: white; border-radius: 10px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .course-detail h1 { color: #333; margin-bottom: 1rem; font-size: 2rem; }
    .course-meta { color: #888; margin-bottom: 1.5rem; font-size: 0.9rem; }
    .course-description { color: #555; line-height: 1.8; font-size: 1.1rem; }
    .section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #eee; }
    .section h2 { color: #333; margin-bottom: 1rem; font-size: 1.3rem; }
    .empty-section { color: #888; font-style: italic; }
    .materials-list { list-style: none; }
    .material-item { display: flex; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.75rem; }
    .material-item:hover { background: #e9ecef; }
    .material-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #667eea; color: white; border-radius: 8px; margin-right: 1rem; font-size: 1.2rem; }
    .material-icon.link { background: #28a745; }
    .material-info { flex: 1; }
    .material-name { font-weight: 600; color: #333; margin-bottom: 0.25rem; }
    .material-desc { font-size: 0.9rem; color: #666; }
    .material-meta { font-size: 0.8rem; color: #888; margin-top: 0.25rem; }
    .material-action { padding: 0.5rem 1rem; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-size: 0.9rem; }
    .material-action:hover { background: #5a6fd6; }
    .material-action.link { background: #28a745; }
    .material-action.link:hover { background: #218838; }
    .quiz-list { list-style: none; }
    .quiz-item { display: flex; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.75rem; }
    .quiz-item:hover { background: #e9ecef; }
    .quiz-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #ffc107; color: white; border-radius: 8px; margin-right: 1rem; font-size: 1.2rem; }
    .quiz-info { flex: 1; }
    .quiz-name { font-weight: 600; color: #333; margin-bottom: 0.25rem; }
    .quiz-desc { font-size: 0.9rem; color: #666; }
    .quiz-meta { font-size: 0.8rem; color: #888; margin-top: 0.25rem; }
    .quiz-action { padding: 0.5rem 1rem; background: #ffc107; color: #333; text-decoration: none; border-radius: 5px; font-size: 0.9rem; font-weight: 500; }
    .quiz-action:hover { background: #e0a800; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
    .modal.active { display: flex; justify-content: center; align-items: flex-start; padding: 2rem; }
    .modal-content { background: white; border-radius: 10px; padding: 2rem; max-width: 700px; width: 100%; margin: 2rem 0; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h2 { font-size: 1.5rem; color: #333; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }
    .close-btn:hover { color: #333; }
    .question { margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; }
    .question-text { font-weight: 600; margin-bottom: 1rem; color: #333; }
    .question-type { font-size: 0.8rem; color: #888; margin-bottom: 0.5rem; }
    .answer-option { display: flex; align-items: center; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; border-radius: 5px; }
    .answer-option:hover { background: #e9ecef; }
    .answer-option input { margin-right: 0.75rem; }
    .submit-quiz { width: 100%; padding: 1rem; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600; }
    .submit-quiz:hover { background: #5a6fd6; }
    .results-container { text-align: center; }
    .score-display { font-size: 3rem; font-weight: bold; color: #667eea; margin: 1rem 0; }
    .score-percent { font-size: 1.2rem; color: #666; }
    .result-item { padding: 1rem; margin-bottom: 0.75rem; border-radius: 8px; text-align: left; }
    .result-item.correct { background: #d4edda; border-left: 4px solid #28a745; }
    .result-item.incorrect { background: #f8d7da; border-left: 4px solid #dc3545; }
    .result-item .question-text { margin-bottom: 0.5rem; }
    .correct-answer { font-size: 0.9rem; color: #28a745; }
  </style>
</head>
<body>
  <nav class="navbar">
    <span class="logo">Think different Academy</span>
    <div>
      <a href="/">Dom≈Ø</a>
      <a href="/courses">Kurzy</a>
      <% if (user) { %>
        <a href="/dashboard">Dashboard</a>
        <a href="/logout">Odhl√°sit</a>
      <% } else { %>
        <a href="/login">P≈ôihl√°sit</a>
      <% } %>
    </div>
  </nav>
  <div class="container">
    <a href="/courses" class="back-link">‚Üê Zpƒõt na seznam kurz≈Ø</a>
    
    <div class="course-detail">
      <h1><%= course.name %></h1>
      <p class="course-meta">ID: <%= course.uuid %></p>
      
      <div class="course-description">
        <%= course.description || course.short_description || 'Tento kurz zat√≠m nem√° popis.' %>
      </div>
      
      <div class="section">
        <h2>Studijn√≠ materi√°ly</h2>
        <% if (materials && materials.length > 0) { %>
          <ul class="materials-list">
            <% materials.forEach(material => { %>
              <li class="material-item">
                <div class="material-icon <%= material.type === 'url' ? 'link' : '' %>">
                  <% if (material.type === 'file') { %>üìÑ<% } else { %>üîó<% } %>
                </div>
                <div class="material-info">
                  <div class="material-name"><%= material.name %></div>
                  <% if (material.description) { %>
                    <div class="material-desc"><%= material.description %></div>
                  <% } %>
                  <% if (material.type === 'file') { %>
                    <div class="material-meta">
                      <%= material.file_name %> 
                      (<%= Math.round(material.file_size / 1024) %> KB)
                    </div>
                  <% } %>
                </div>
                <% if (material.type === 'file') { %>
                  <a href="/uploads/<%= require('path').basename(material.file_path) %>" class="material-action" download>St√°hnout</a>
                <% } else { %>
                  <a href="<%= material.url %>" class="material-action link" target="_blank" rel="noopener">Otev≈ô√≠t</a>
                <% } %>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="empty-section">≈Ω√°dn√© materi√°ly zat√≠m nejsou k dispozici.</p>
        <% } %>
      </div>
      
      <div class="section">
        <h2>Kv√≠zy</h2>
        <% if (quizzes && quizzes.length > 0) { %>
          <ul class="quiz-list">
            <% quizzes.forEach(quiz => { %>
              <li class="quiz-item">
                <div class="quiz-icon">üìù</div>
                <div class="quiz-info">
                  <div class="quiz-name"><%= quiz.name %></div>
                  <% if (quiz.description) { %>
                    <div class="quiz-desc"><%= quiz.description %></div>
                  <% } %>
                  <div class="quiz-meta">Vyplnƒõno <%= quiz.completionCount %>√ó</div>
                </div>
                <button class="quiz-action" onclick="openQuiz('<%= quiz.uuid %>')">Spustit kv√≠z</button>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="empty-section">≈Ω√°dn√© kv√≠zy zat√≠m nejsou k dispozici.</p>
        <% } %>
      </div>
    </div>
  </div>
  
  <!-- Quiz Modal -->
  <div id="quizModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="quizTitle">Kv√≠z</h2>
        <button class="close-btn" onclick="closeQuiz()">&times;</button>
      </div>
      <div id="quizContent"></div>
    </div>
  </div>
  
  <script>
    const courseUuid = '<%= course.uuid %>';
    let currentQuiz = null;
    
    async function openQuiz(quizUuid) {
      try {
        const response = await fetch(`/api/courses/${courseUuid}/quizzes/${quizUuid}`);
        const quiz = await response.json();
        currentQuiz = quiz;
        
        document.getElementById('quizTitle').textContent = quiz.name;
        document.getElementById('quizModal').classList.add('active');
        
        renderQuiz(quiz);
      } catch (error) {
        console.error('Error loading quiz:', error);
        alert('Nepoda≈ôilo se naƒç√≠st kv√≠z');
      }
    }
    
    function closeQuiz() {
      document.getElementById('quizModal').classList.remove('active');
      currentQuiz = null;
    }
    
    function renderQuiz(quiz) {
      const container = document.getElementById('quizContent');
      
      if (!quiz.questions || quiz.questions.length === 0) {
        container.innerHTML = '<p>Tento kv√≠z zat√≠m nem√° ≈æ√°dn√© ot√°zky.</p>';
        return;
      }
      
      let html = '<form id="quizForm" onsubmit="submitQuiz(event)">';
      
      quiz.questions.forEach((question, qIndex) => {
        const inputType = question.type === 'single' ? 'radio' : 'checkbox';
        const inputName = question.type === 'single' ? `question_${question.uuid}` : `question_${question.uuid}[]`;
        
        html += `
          <div class="question" data-question-uuid="${question.uuid}" data-type="${question.type}">
            <div class="question-type">${question.type === 'single' ? 'Vyberte jednu odpovƒõƒè' : 'Vyberte v√≠ce odpovƒõd√≠'}</div>
            <div class="question-text">${qIndex + 1}. ${question.text}</div>
        `;
        
        question.answers.forEach(answer => {
          html += `
            <label class="answer-option">
              <input type="${inputType}" name="${inputName}" value="${answer.uuid}">
              ${answer.text}
            </label>
          `;
        });
        
        html += '</div>';
      });
      
      html += '<button type="submit" class="submit-quiz">Odeslat kv√≠z</button></form>';
      container.innerHTML = html;
    }
    
    async function submitQuiz(e) {
      e.preventDefault();
      
      if (!currentQuiz) return;
      
      const answers = [];
      
      currentQuiz.questions.forEach(question => {
        if (question.type === 'single') {
          const selected = document.querySelector(`input[name="question_${question.uuid}"]:checked`);
          if (selected) {
            answers.push({ questionUuid: question.uuid, answerUuid: selected.value });
          }
        } else {
          const selected = document.querySelectorAll(`input[name="question_${question.uuid}[]"]:checked`);
          const answerUuids = Array.from(selected).map(el => el.value);
          answers.push({ questionUuid: question.uuid, answerUuids });
        }
      });
      
      try {
        const response = await fetch(`/api/courses/${courseUuid}/quizzes/${currentQuiz.uuid}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers })
        });
        
        const result = await response.json();
        renderResults(result);
      } catch (error) {
        console.error('Error submitting quiz:', error);
        alert('Nepoda≈ôilo se odeslat kv√≠z');
      }
    }
    
    function renderResults(result) {
      const container = document.getElementById('quizContent');
      
      let html = `
        <div class="results-container">
          <h3>V√Ωsledky kv√≠zu</h3>
          <div class="score-display">${result.score} / ${result.maxScore}</div>
          <div class="score-percent">${result.percentage}% spr√°vnƒõ</div>
        </div>
        <div style="margin-top: 1.5rem;">
      `;
      
      result.results.forEach((r, index) => {
        html += `
          <div class="result-item ${r.isCorrect ? 'correct' : 'incorrect'}">
            <div class="question-text">${index + 1}. ${r.questionText}</div>
            <div class="correct-answer">
              Spr√°vn√° odpovƒõƒè: ${r.correctAnswers.map(a => a.text).join(', ')}
            </div>
          </div>
        `;
      });
      
      html += `
        </div>
        <button onclick="closeQuiz()" class="submit-quiz" style="margin-top: 1rem;">Zav≈ô√≠t</button>
      `;
      
      container.innerHTML = html;
      
      // Refresh page to update completion count
      setTimeout(() => {
        if (document.getElementById('quizModal').classList.contains('active') === false) {
          location.reload();
        }
      }, 100);
    }
    
    // Close modal when clicking outside
    document.getElementById('quizModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQuiz();
        location.reload();
      }
    });
  </script>
</body>
</html>